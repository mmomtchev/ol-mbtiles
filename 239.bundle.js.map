{"version":3,"file":"239.bundle.js","mappings":"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","sources":["webpack://ol-mbtiles/./examples/code/reunion-raster.ts","webpack://ol-mbtiles/./src/debug.ts","webpack://ol-mbtiles/./src/mbtiles.ts","webpack://ol-mbtiles/./src/mbtiles-format.ts","webpack://ol-mbtiles/./src/mbtiles-vector-source.ts","webpack://ol-mbtiles/./src/mbtiles-raster-source.ts","webpack://ol-mbtiles/./node_modules/ol/source/OSM.js"],"sourcesContent":["import Map from 'ol/Map.js';\nimport TileLayer from 'ol/layer/Tile.js';\nimport OSM from 'ol/source/OSM';\nimport View from 'ol/View.js';\nimport ImageTileLayer from 'ol/layer/Tile';\nimport TileDebug from 'ol/source/TileDebug';\nimport { fromLonLat } from 'ol/proj';\n\nimport { importMBTiles, MBTilesRasterSource } from 'ol-mbtiles';\n\n// Raster MBTiles from\n// https://www.data.gouv.fr/en/datasets/pyramide-de-tuiles-depuis-la-bd-ortho-r/\n// 240MB original file\n\nexport default async function () {\n  return new Map({\n    target: 'map',\n    layers: [\n      new TileLayer({\n        zIndex: 20,\n        source: new TileDebug()\n      }),\n      new TileLayer({\n        zIndex: 10,\n        opacity: 0.4,\n        source: new OSM(),\n      }),\n      new ImageTileLayer({\n        zIndex: 0,\n        source: new MBTilesRasterSource(\n          await importMBTiles({ url: 'https://velivole.b-cdn.net/tiles-RGR92UTM40S.mbtiles' }),\n        ),\n      })\n    ],\n    view: new View({\n      center: fromLonLat([55.47437, -21.08468]),\n      zoom: 9\n    }),\n  });\n}\n","declare const OL_MBTILES_DEBUG: string;\nconst debugEnabled = (typeof OL_MBTILES_DEBUG !== 'undefined' && OL_MBTILES_DEBUG) ||\n  (typeof process !== 'undefined' && typeof process?.env?.OL_MBTILES_DEBUG !== 'undefined' && process.env.OL_MBTILES_DEBUG);\n\nexport const debug = debugEnabled ? console.debug.bind(console) : () => undefined;\n","import { createSQLiteHTTPPool, SQLiteHTTPPool, VFSHTTP } from 'sqlite-wasm-http';\n\nimport { Options as ImageTileOptions } from 'ol/source/TileImage.js';\nimport { Options as VectorTileOptions } from 'ol/source/VectorTile.js';\nimport { get as getProjection, transformExtent } from 'ol/proj.js';\nimport { getWidth } from 'ol/extent.js';\nimport TileGrid from 'ol/tilegrid/TileGrid.js';\nimport { debug } from './debug';\n\n/**\n * Options for creating a MBTilesRasterSource\n */\nexport interface MBTilesRasterOptions extends ImageTileOptions {\n  /**\n   * Number of parallel workers to use for retrieving tiles, @default 4\n   */\n  sqlWorkers?: number;\n  /**\n   * List of layer names to selectively include, @default everything\n   */\n  layers?: string[];\n\n  tileUrlFunction?: never;\n  tileLoadFunction?: never;\n\n  /**\n   * Alternative method of specifying minZoom, mutually exclusive with tileGrid, requires explicit projection\n   */\n  minZoom?: number;\n\n  /**\n   * Alternative method of specifying minZoom, mutually exclusive with tileGrid, requires explicit projection\n   */\n  maxZoom?: number;\n\n  /**\n   * Optional tile grid, refer to the Openlayers manual\n   */\n  tileGrid?: TileGrid;\n\n  /**\n   * Optional already open SQLiteHTTP pool (mutually exclusive with url)\n   */\n  pool?: Promise<SQLiteHTTPPool>;\n}\n\n/**\n * Options for creating a MBTilesVectorSource\n */\nexport interface MBTilesVectorOptions extends VectorTileOptions {\n  /**\n   * Number of parallel workers to use for retrieving tiles, @default 4\n   */\n  sqlWorkers?: number;\n  /**\n   * List of layer names to selectively include, @default everything\n   */\n  layers?: string[];\n\n  /**\n   * Optional already open SQLiteHTTP pool (mutually exclusive with url)\n   */\n  pool?: Promise<SQLiteHTTPPool>;\n\n  tileUrlFunction?: never;\n  tileLoadFunction?: never;\n  format?: never;\n}\n\n/**\n * Shared options for all MBTiles\n */\nexport interface SQLOptions {\n  /**\n   * URL of the remote MBTiles source\n   */\n  url: string;\n  /**\n   * Number of parallel workers to use for retrieving tiles, @default 4\n   */\n  sqlWorkers?: number;\n\n  /**\n   * Maximum expected page size in bytes for SQLite3 files, @default 4096\n   */\n  maxSqlPageSize?: number;\n\n  /**\n   * Memory to use for SQLite cache in KB, @default 4096\n   */\n  sqlCacheSize?: number;\n\n  /**\n   * Use a specific backend type, @default 'shared'\n   */\n  backendType?: VFSHTTP.Options['backendType'];\n}\n\nexport type MBTilesOptions = MBTilesVectorOptions | MBTilesRasterOptions;\n\nconst formats: Record<string, 'raster' | 'vector'> = {\n  'jpg': 'raster',\n  'png': 'raster',\n  'webp': 'raster',\n  'pbf': 'vector',\n  'mvt': 'vector'\n};\n\nexport function httpPoolOptions(options?: SQLOptions) {\n  return {\n    workers: options?.sqlWorkers ?? 4,\n    httpOptions: {\n      backendType: options?.backendType,\n      maxPageSize: options?.maxSqlPageSize ?? 4096,\n      cacheSize: options?.sqlCacheSize ?? 4096\n    } as VFSHTTP.Options,\n  };\n}\n\n/**\n * Automatically import MBTiles metadata and return an options object\n * compatible with the source constructors.\n * \n * @param {(MBTilesRasterOptions | MBTilesVectorOptions) & SQLOptions} opt Any MBTiles{Raster|Vector}Source options to be overridden\n * @param {string} opt.url URL of the remote tileset\n * @returns {(MBTilesRasterOptions | MBTilesVectorOptions)}\n */\nexport function importMBTiles<T extends MBTilesOptions>(opt: SQLOptions & T): Promise<T & SQLOptions> {\n  const pool: Promise<SQLiteHTTPPool> = createSQLiteHTTPPool(httpPoolOptions(opt))\n    .then((pool) => pool.open(opt.url).then(() => pool));\n\n  return pool\n    .then((p) => p.exec('SELECT name,value FROM metadata'))\n    .then((r) => {\n      if (r && r.length) {\n        // Transform an array of form [ ['name', 'value' ], ... ] to object\n        const data = r.reduce((a, x) => {\n          a[x.row[0] as string] = x.row[1] as string;\n          return a;\n        }, {} as Record<string, string>);\n        debug('Loaded metadata', data);\n        return data;\n      }\n      throw new Error('Could not load metadata');\n    })\n    .then((md) => {\n      const opts = {...opt} as T & SQLOptions;\n\n      const format = (md['format'] as string)?.toLowerCase?.();\n      if (!formats[format])\n        console.warn('Unknown tile format', format);\n\n      // Sometimes, I wonder if Mapbox doesn't hold a patent or some\n      // other kind of investment related to everyone using 3857\n      opts.projection = opt.projection ?? 'EPSG:3857';\n      opts.attributions = (md.attribution ?? md.description) as string;\n      opts.maxZoom = opt.maxZoom ?? +md['maxzoom'];\n      opts.minZoom = opt.minZoom ?? +md['minzoom'];\n\n      const projExtent = getProjection(opts.projection)?.getExtent?.();\n      const bounds = md['bounds'] as string;\n      const extent = bounds ?\n        transformExtent(bounds.split(',').map((r) => +r), 'EPSG:4326', opts.projection) :\n        projExtent;\n\n      if (formats[format] === 'raster') {\n        if (opts.maxZoom === undefined || opts.minZoom === undefined || projExtent === undefined)\n          throw new Error('Cannot determine tilegrid, need minZoom, maxZoom');\n        const baseResolution = getWidth(projExtent) / 256;\n        const resolutions = [baseResolution];\n        for (let z = 1; z <= opts.maxZoom; z++)\n          resolutions.push(resolutions[resolutions.length - 1] / 2);\n\n        opts.tileGrid = new TileGrid({\n          origin: [projExtent[0], projExtent[2]],\n          extent,\n          minZoom: opts.minZoom,\n          resolutions\n        });\n      } else {\n        const vectorOpts = opts as MBTilesVectorOptions;\n        // Alas VectorTileSource in Openlayers does not support\n        // constraining the extent while keeping the origin\n        vectorOpts.extent = projExtent;\n      }\n      opts.pool = pool;\n      opts.url = opt.url;\n\n      return opts;\n    });\n}\n","import Protobuf from 'pbf';\nimport { VectorTile, VectorTileFeature } from '@mapbox/vector-tile';\nimport pako from 'pako';\n\nimport FeatureFormat, { ReadOptions } from 'ol/format/Feature.js';\nimport Projection from 'ol/proj/Projection.js';\nimport RenderFeature from 'ol/render/Feature.js';\nimport { FeatureLike } from 'ol/Feature.js';\nimport { get as getProjection } from 'ol/proj.js';\nimport { Type } from 'ol/geom/Geometry.js';\n\ndeclare module '@mapbox/vector-tile' {\n  interface VectorTileFeature {\n    toGeoJSON(x: number, y: number, z: number, project?: (xy: [number, number]) => [number, number]): GeoJSON.Feature;\n  }\n}\n\nexport interface Options {\n  layers?: string[];\n  featureClass?: typeof RenderFeature;\n  geometryName?: string;\n  idProperty?: string;\n  extent?: number;\n}\n\nexport class MBTilesFormat extends FeatureFormat {\n  dataProjection: Projection;\n  private featureClass_: typeof RenderFeature;\n  private geometryName_: string;\n  private layers_: string[] | null;\n  private idProperty_: string | undefined;\n  supportedMediaTypes: string[];\n  extent: number;\n  static MBTypes = {\n    mono: ['Unknown', 'Point', 'LineString', 'Polygon' ],\n    multi: ['Unknown', 'MultiPoint', 'MultiLineString', 'Polygon']\n   } as Record<'mono' | 'multi', (Type | 'Unknown')[]>;\n\n  constructor(options?: Options) {\n    super();\n\n    options = options ? options : {};\n\n    this.dataProjection = new Projection({\n      code: '',\n      units: 'tile-pixels',\n    });\n\n    this.featureClass_ = options.featureClass ? options.featureClass : RenderFeature;\n    this.geometryName_ = options.geometryName ?? 'Geometry';\n    this.layers_ = options.layers ?? null;\n    this.idProperty_ = options.idProperty;\n    this.extent = options.extent ?? 4096;\n\n    /*\n     * As this is the very first time MBTiles will be distributed by HTTP\n     * there is still no official MIME type\n     */\n    this.supportedMediaTypes = [\n      'application/vnd-mbtiles'\n    ];\n  }\n\n  readFeature(source: VectorTileFeature, options?: ReadOptions): FeatureLike {\n    const properties = source.properties;\n\n    let id: string | number;\n    if (!this.idProperty_) {\n      id = source.id;\n    } else {\n      id = properties[this.idProperty_] as string | number;\n      delete properties[this.idProperty_];\n    }\n    const points = source.loadGeometry();\n    const flatCoordinates = [] as number[];\n    const ends = [] as number[];\n\n    const type: Type | 'Unknown' = MBTilesFormat.MBTypes[points.length > 1 ? 'multi' : 'mono'][source.type];\n    if (type === 'Unknown')\n    // TODO: fix in Openlayers\n      return null as unknown as FeatureLike;\n\n    for (let i = 0; i < points.length; i++) {\n      if (points[i].length == 0)\n        continue;\n      for (let j = 0; j < points[i].length; j++) {\n        flatCoordinates.push(points[i][j].x, points[i][j].y);\n      }\n      ends.push(flatCoordinates.length);\n    }\n\n    const feature = new this.featureClass_(type, flatCoordinates, ends, properties, id);\n    feature.transform(options?.dataProjection);\n\n    return feature;\n  }\n\n  readFeatures(source: ArrayBuffer, options?: ReadOptions): FeatureLike[] {\n    const layers = this.layers_;\n\n    const features: FeatureLike[] = [];\n    const tile = new VectorTile(new Protobuf(pako.ungzip(source)));\n    options = this.adaptOptions(options);\n    const dataProjection = getProjection(options?.dataProjection);\n    const extent = options?.extent;\n    if (!dataProjection || !options || !extent)\n      throw new Error('Cannot determine the projection/extent');\n    dataProjection.setWorldExtent(extent);\n    dataProjection.setExtent([0, 0, this.extent, this.extent]);\n    options.dataProjection = dataProjection;\n\n    for (const layerName of Object.keys(tile.layers)) {\n      if (layers && !layers.includes(layerName)) {\n        continue;\n      }\n      const l = tile.layers[layerName];\n      for (let idx = 0; idx < l.length; idx++) {\n        const vectorFeature = l.feature(idx);\n        const feature = this.readFeature(vectorFeature, options);\n        feature.getProperties().layer = layerName;\n        features.push(feature);\n      }\n    }\n\n    return features;\n  }\n\n  readProjection() {\n    return this.dataProjection;\n  }\n}\n","import { createSQLiteHTTPPool, SQLiteHTTPPool } from 'sqlite-wasm-http';\n\nimport VectorTileSource from 'ol/source/VectorTile.js';\nimport VectorTile from 'ol/VectorTile.js';\nimport { TileCoord } from 'ol/tilecoord.js';\nimport Feature from 'ol/Feature.js';\nimport { Geometry } from 'ol/geom.js';\n\nimport { httpPoolOptions, MBTilesVectorOptions, SQLOptions } from './mbtiles';\nimport { MBTilesFormat } from './mbtiles-format';\nimport { debug } from './debug';\nimport Tile from 'ol/Tile';\n\n/**\n * A tile source in a remote .mbtiles file accessible by HTTP\n * \n * WARNING\n * If your application continuously creates and removes MBTilesSource\n * objects, special care must be taken to properly dispose of them.\n * An MBTilesSource creates a thread pool that the JS engine is unable to\n * automatically garbage-collect unless the dispose() method\n * is invoked.\n * If you need to dispose a map that can potentially contain\n * MBTilesSource objects, check loadExample() in\n * https://github.com/mmomtchev/ol-mbtiles/blob/main/examples/index.ts#L15\n */\nexport class MBTilesVectorSource extends VectorTileSource {\n  private pool: Promise<SQLiteHTTPPool>;\n\n  /**\n   * @param {MBTilesVectorOptions} options options\n   */\n  constructor(options: MBTilesVectorOptions & SQLOptions) {\n    if (options.url === undefined && options.pool === undefined)\n      throw new Error('Must specify url');\n\n      super({\n      ...options,\n      url: undefined,\n      format: new MBTilesFormat({\n        layers: options.layers\n      }),\n      // This is required to prevent Openlayers' cache from thinking that all tiles share the same URL\n      tileUrlFunction: (coords: TileCoord) => `${options.url}#${coords[0]}:${coords[1]}:${coords[2]}`\n    });\n\n    this.setTileLoadFunction(this.tileLoader.bind(this));\n\n    this.pool = options.pool ?? createSQLiteHTTPPool(httpPoolOptions(options))\n      .then((pool) => pool.open(options.url).then(() => pool));\n  }\n\n  private tileLoader(_tile: Tile, _url: string) {\n    // TODO fix the type in Openlayers after the war\n    const tile = _tile as VectorTile;\n    debug('loading tile', [tile.tileCoord[0], tile.tileCoord[1], tile.tileCoord[2]]);\n    tile.setLoader((extent, resolution, projection) => {\n      this.pool\n        .then((p) =>\n          p.exec(\n            'SELECT tile_data FROM tiles WHERE zoom_level = $zoom AND tile_column = $col AND tile_row = $row',\n            {\n              $zoom: tile.tileCoord[0],\n              $col: tile.tileCoord[1],\n              $row: (1 << tile.tileCoord[0]) - 1 - tile.tileCoord[2]\n            }\n          ))\n        .then((r) => {\n          if (r && r[0] && r[0].row[0]) {\n            const format = tile.getFormat();\n            const features = format.readFeatures(r[0].row[0], {\n              extent,\n              featureProjection: projection\n            }) as Feature<Geometry>[];\n            tile.setFeatures(features);\n            tile.onLoad(features, projection);\n            return;\n          }\n          throw new Error(`No data for ${tile.tileCoord}`);\n        })\n        .catch((e) => {\n          debug(e);\n          tile.onError();\n        });\n    });\n  }\n\n  disposeInternal() {\n    return this.pool.then((p) => p.close());\n  }\n}\n","import { createSQLiteHTTPPool, SQLiteHTTPPool } from 'sqlite-wasm-http';\n\nimport ImageTileSource from 'ol/source/TileImage.js';\nimport Tile from 'ol/Tile.js';\nimport ImageTile from 'ol/ImageTile.js';\nimport { TileCoord } from 'ol/tilecoord.js';\nimport TileState from 'ol/TileState.js';\n\nimport { httpPoolOptions, MBTilesRasterOptions, SQLOptions } from './mbtiles';\nimport { debug } from './debug';\n\n/**\n * A tile source in a remote .mbtiles file accessible by HTTP\n * \n * WARNING\n * If your application continuously creates and removes MBTilesSource\n * objects, special care must be taken to properly dispose of them.\n * An MBTilesSource creates a thread pool that the JS engine is unable to\n * automatically garbage-collect unless the dispose() method\n * is invoked.\n * If you need to dispose a map that can potentially contain\n * MBTilesSource objects, check loadExample() in\n * https://github.com/mmomtchev/ol-mbtiles/blob/main/examples/index.ts#L15\n */\nexport class MBTilesRasterSource extends ImageTileSource {\n  private pool: Promise<SQLiteHTTPPool>;\n\n  /**\n   * @param {MBTilesRasterOptions} options options\n   */\n  constructor(options: MBTilesRasterOptions & SQLOptions) {\n    if (options.url === undefined && options.pool === undefined)\n      throw new Error('Must specify url');\n\n    super({\n      ...options,\n      url: undefined,\n      // This is required to prevent Openlayers' cache from thinking that all tiles share the same URL\n      tileUrlFunction: (coords: TileCoord) => `${options.url}#${coords[0]}:${coords[1]}:${coords[2]}`\n    });\n\n    this.setTileLoadFunction(this.tileLoader.bind(this));\n\n    this.pool = options.pool ?? createSQLiteHTTPPool(httpPoolOptions(options))\n      .then((pool) => pool.open(options.url).then(() => pool));\n  }\n\n  // TODO fix the tile type in Openlayers\n  private tileLoader(tile: Tile, _url: string) {\n    debug('loading tile', [tile.tileCoord[0], tile.tileCoord[1], tile.tileCoord[2]]);\n    const image = (tile as ImageTile).getImage() as HTMLImageElement;\n    this.pool\n      .then((p) =>\n        p.exec(\n          'SELECT tile_data FROM tiles WHERE zoom_level = $zoom AND tile_column = $col AND tile_row = $row',\n          {\n            $zoom: tile.tileCoord[0],\n            $col: tile.tileCoord[1],\n            $row: (1 << tile.tileCoord[0]) - 1 - tile.tileCoord[2]\n          }\n        ))\n      .then((r) => {\n        if (r && r[0]) {\n          if (r[0].row[0] instanceof Uint8Array) {\n            const blob = new Blob([r[0].row[0] as Uint8Array]);\n            const imageUrl = URL.createObjectURL(blob);\n            image.src = imageUrl;\n            return;\n          }\n        }\n        throw new Error(`No data for ${tile.tileCoord}`);\n      })\n      .catch((e) => {\n        debug(e);\n        tile.setState(TileState.ERROR);\n      });\n  }\n\n  disposeInternal() {\n    return this.pool.then((p) => p.close());\n  }\n}\n","/**\n * @module ol/source/OSM\n */\n\nimport XYZ from './XYZ.js';\n\n/**\n * The attribution containing a link to the OpenStreetMap Copyright and License\n * page.\n * @const\n * @type {string}\n * @api\n */\nexport const ATTRIBUTION =\n  '&#169; ' +\n  '<a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">OpenStreetMap</a> ' +\n  'contributors.';\n\n/**\n * @typedef {Object} Options\n * @property {import(\"./Source.js\").AttributionLike} [attributions] Attributions.\n * @property {number} [cacheSize] Initial tile cache size. Will auto-grow to hold at least the number of tiles in the viewport.\n * @property {null|string} [crossOrigin='anonymous'] The `crossOrigin` attribute for loaded images.  Note that\n * you must provide a `crossOrigin` value if you want to access pixel data with the Canvas renderer.\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image for more detail.\n * @property {boolean} [interpolate=true] Use interpolated values when resampling.  By default,\n * linear interpolation is used when resampling.  Set to false to use the nearest neighbor instead.\n * @property {number} [maxZoom=19] Max zoom.\n * @property {boolean} [opaque=true] Whether the layer is opaque.\n * @property {number} [reprojectionErrorThreshold=0.5] Maximum allowed reprojection error (in pixels).\n * Higher values can increase reprojection performance, but decrease precision.\n * @property {import(\"../Tile.js\").LoadFunction} [tileLoadFunction] Optional function to load a tile given a URL. The default is\n * ```js\n * function(imageTile, src) {\n *   imageTile.getImage().src = src;\n * };\n * ```\n * @property {number} [transition=250] Duration of the opacity transition for rendering.\n * To disable the opacity transition, pass `transition: 0`.\n * @property {string} [url='https://tile.openstreetmap.org/{z}/{x}/{y}.png'] URL template.\n * Must include `{x}`, `{y}` or `{-y}`, and `{z}` placeholders.\n * @property {boolean} [wrapX=true] Whether to wrap the world horizontally.\n * @property {number|import(\"../array.js\").NearestDirectionFunction} [zDirection=0]\n * Choose whether to use tiles with a higher or lower zoom level when between integer\n * zoom levels. See {@link module:ol/tilegrid/TileGrid~TileGrid#getZForResolution}.\n */\n\n/**\n * @classdesc\n * Layer source for the OpenStreetMap tile server.\n * @api\n */\nclass OSM extends XYZ {\n  /**\n   * @param {Options} [options] Open Street Map options.\n   */\n  constructor(options) {\n    options = options || {};\n\n    let attributions;\n    if (options.attributions !== undefined) {\n      attributions = options.attributions;\n    } else {\n      attributions = [ATTRIBUTION];\n    }\n\n    const crossOrigin =\n      options.crossOrigin !== undefined ? options.crossOrigin : 'anonymous';\n\n    const url =\n      options.url !== undefined\n        ? options.url\n        : 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\n\n    super({\n      attributions: attributions,\n      attributionsCollapsible: false,\n      cacheSize: options.cacheSize,\n      crossOrigin: crossOrigin,\n      interpolate: options.interpolate,\n      maxZoom: options.maxZoom !== undefined ? options.maxZoom : 19,\n      opaque: options.opaque !== undefined ? options.opaque : true,\n      reprojectionErrorThreshold: options.reprojectionErrorThreshold,\n      tileLoadFunction: options.tileLoadFunction,\n      transition: options.transition,\n      url: url,\n      wrapX: options.wrapX,\n      zDirection: options.zDirection,\n    });\n  }\n}\n\nexport default OSM;\n"],"names":["target","layers","zIndex","source","opacity","url","view","center","zoom","debug","process","env","OL_MBTILES_DEBUG","console","bind","formats","httpPoolOptions","options","workers","sqlWorkers","httpOptions","backendType","maxPageSize","maxSqlPageSize","cacheSize","sqlCacheSize","importMBTiles","opt","pool","then","open","p","exec","r","length","data","reduce","a","x","row","Error","md","opts","format","toLowerCase","warn","projection","attributions","attribution","description","maxZoom","minZoom","projExtent","getExtent","bounds","extent","split","map","undefined","resolutions","z","push","tileGrid","TileGrid","origin","MBTilesFormat","Feature","constructor","super","this","dataProjection","Projection","code","units","featureClass_","featureClass","geometryName_","geometryName","layers_","idProperty_","idProperty","supportedMediaTypes","readFeature","properties","id","points","loadGeometry","flatCoordinates","ends","type","MBTypes","i","j","y","feature","transform","readFeatures","features","tile","VectorTile","adaptOptions","setWorldExtent","setExtent","layerName","Object","keys","includes","l","idx","vectorFeature","getProperties","layer","readProjection","mono","multi","MBTilesVectorSource","tileUrlFunction","coords","setTileLoadFunction","tileLoader","_tile","_url","tileCoord","setLoader","resolution","$zoom","$col","$row","getFormat","featureProjection","setFeatures","onLoad","catch","e","onError","disposeInternal","close","MBTilesRasterSource","image","getImage","Uint8Array","blob","Blob","imageUrl","URL","createObjectURL","src","setState","TileState","OSM","crossOrigin","attributionsCollapsible","interpolate","opaque","reprojectionErrorThreshold","tileLoadFunction","transition","wrapX","zDirection"],"sourceRoot":""}